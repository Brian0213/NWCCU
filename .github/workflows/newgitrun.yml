name: Run Selenium Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    # Install Google Chrome (required for Selenium tests)
    - name: Install Chrome Driver
      run: |
          wget https://chromedriver.storage.googleapis.com/$(curl -s https://chromedriver.storage.googleapis.com/LATEST_RELEASE)/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

    - name: Set Chrome binary path (Important for headless mode)
      run: |
          mkdir -p /opt/google/chrome
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          sudo apt-get install -y --fix-broken
          sudo apt-get install -y xvfb
      
    # Remove any old chromedriver so Selenium Manager can pick the correct version
    - name: Remove old ChromeDriver
      run: sudo rm -f /usr/local/bin/chromedriver

    - name: Install Allure CLI
      run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.32.0/allure-2.32.0.zip
          unzip allure-2.32.0.zip
          export PATH=$PATH:$(pwd)/allure-2.32.0/bin
          allure --version

    - name: Build with Maven
      run: mvn clean install -DskipTests=true

    - name: Run Selenium Tests
      run: mvn test -Dos=linux -Dbrowser=chrome

    - name: Show Surefire Reports (Debug)
      if: failure()
      run: |
        echo "----- TEST FAILURES -----"
        cat target/surefire-reports/*.txt || true
        echo "----- END REPORTS -----"

    - name: Generate Allure Report
      run: |
          export PATH=$PATH:$(pwd)/allure-2.32.0/bin
          mkdir allure-report
          
          allure generate Reports -o allure-report --clean

    - name: Upload Allure Report as Artifact
      uses: actions/upload-artifact@v4
      with:
          name: Allure Report
          path: allure-report

    - name: Deploy Allure Report to GitHub Pages
      if: ${{ github.event_name == 'push' }}
      uses: peaceiris/actions-gh-pages@v4
      with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          publish_dir: ./allure-report
          publish_branch: gh-pages
          force_orphan: true

  


